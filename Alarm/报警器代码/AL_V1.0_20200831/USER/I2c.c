#include "includes.h"

//==================================================================================================
//| 文件名称 | I2C.c/I2C.h 
//|----------|--------------------------------------------------------------------------------------
//| 文件功能 | 通过IO口模拟方式实现I2C通信
//|----------|--------------------------------------------------------------------------------------       
//| 文件设计 | 编写人：ZH    时间：2015-10-28 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 无
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================


//==================================================================================================
//| 函数名称 | I2C_GPIO_Config 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | I2C IO口配置
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 把SCL SDA都配置为普通IO
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
void I2C_GPIO_Config(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;

	/***????***/
	RCC_APB2PeriphClockCmd(I2C_SCL_PORT_RCC | I2C_SDA_PORT_RCC , ENABLE);
		
	//GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;
	//GPIO_InitStructure.GPIO_OType = GPIO_OType_OD;//
	//GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	//GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL; 
    
	//RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA|RCC_APB2Periph_GPIOB|RCC_APB2Periph_AFIO,ENABLE);//??PA PB????
	
	//GPIO_PinRemapConfig(GPIO_Remap_SWJ_JTAGDisable,ENABLE);
	
	//GPIO_InitStructure.GPIO_Pin = GPIO_Pin_5;           //LED1->PB5
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;   //??????,????????? 2 10 50
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_OD;    //??????,?????????

	/***???SDL, ????***/
	GPIO_InitStructure.GPIO_Pin = I2C_SCL_PIN; 
	GPIO_Init(I2C_SCL_PORT, &GPIO_InitStructure);
		
	/***???SDA, ????***/
	GPIO_InitStructure.GPIO_Pin = I2C_SDA_PIN; 
	GPIO_Init(I2C_SDA_PORT, &GPIO_InitStructure);	
    
    I2C_SCL_H;
    I2C_SCL_H;
}

//==================================================================================================
//| 函数名称 | I2C_Delay 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | I2C 延时函数
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | num延时数
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | us级,4.7us 6.7us
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
void I2C_Delay(unsigned int num)
{
	while(num--)
	{
		System72MDelay1us();
	}	
}

//==================================================================================================
//| 函数名称 | I2C_FromBusyToIdle 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | I2C 通过发送9个时钟脉冲信号使总线从死锁状态中恢复
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
void I2C_FromBusyToIdle(void)
{
    unsigned char i;
    
	I2C_Delay(6);
    for(i=0; i<9;i++)
    {
        I2C_SCL_L;
        I2C_Delay(6);//起始条件建立时间大于4.7us延时 
        I2C_SCL_H;
        I2C_Delay(6);//起始条件建立时间大于4.7us延时        
    }
}
//==================================================================================================
//| 函数名称 | I2C_Start 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | I2C 起始信号
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
unsigned char I2C_Start(void)
{
	I2C_Delay(3);
	I2C_SDA_H; //发送起始条件的数据信号
	I2C_SCL_H;
	I2C_Delay(6);//起始条件建立时间大于4.7us延时
	if(!I2C_SDA_READ())
	{//总线可能已经死锁
		I2C_FromBusyToIdle();
		if(!I2C_SDA_READ())
		{
			return 0; //SDA线为低电平则总线忙,退出        
		}
	}
	I2C_SDA_L; //发送起始信号
	I2C_Delay(3);
	if(I2C_SDA_READ())
	{
		return 0; //SDA线为高电平则总线出错,退出
	}	 
	I2C_SCL_L;//锁定I2C总线，准备发送或接收数据
	I2C_Delay(3);
	return 1;
}
//==================================================================================================
//| 函数名称 | I2C_Stop 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | I2C结束信号
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
void I2C_Stop(void)
{
	I2C_Delay(3);
	I2C_SCL_L;
	I2C_Delay(3);
	I2C_SDA_L; //发送结束条件的数据信号
	I2C_Delay(3);
	I2C_SCL_H;//发送结束条件的时钟信号
	I2C_Delay(6);//结束条件建立时间大于4μ
	I2C_SDA_H;//发送I2C总线结束信号
	I2C_Delay(3);
}

//==================================================================================================
//| 函数名称 | I2C_Ack 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | I2C应答信号
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
void I2C_Ack(void)
{
	I2C_Delay(6);
	I2C_SCL_L;
	I2C_Delay(6);
	I2C_SDA_L;
	I2C_Delay(6);
	I2C_SCL_H;
	I2C_Delay(6);  //时钟低电平周期大于4μ
	I2C_SCL_L;	//清时钟线，锁定I2C总线以便继续接收
	I2C_Delay(3);
}

//==================================================================================================
//| 函数名称 | I2C_NoAck 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | I2C非应答信号
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
void I2C_NoAck(void)
{
	I2C_Delay(3); 
	I2C_SCL_L;
	I2C_Delay(3);
	I2C_SDA_H;
	I2C_Delay(3);
	I2C_SCL_H;
	I2C_Delay(6);//时钟低电平周期大于4μ
	I2C_SCL_L;//清时钟线，锁定I2C总线以便继续接收
	I2C_Delay(3);
}

//==================================================================================================
//| 函数名称 | I2C_WaitAck 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 等待应答信号
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 1有ACK
//|          | 0无ACK
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
unsigned char I2C_WaitAck(void)  //
{
	I2C_Delay(3);
	I2C_SCL_L;
	I2C_Delay(3);
	I2C_SDA_H; 

	I2C_Delay(3);
	I2C_SCL_H;
	I2C_Delay(3);
	if(I2C_SDA_READ())
	{ 
		I2C_SCL_L;
		return 0;
	}	 
	I2C_SCL_L;
	return 1;
}
//==================================================================================================
//| 函数名称 | I2C_SendByte 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 发送1个字节数据
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | SendByte 要数据的数据(1个字节)
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 数据从高位到低位
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
void I2C_SendByte(unsigned char SendByte) 
{
	unsigned char i=8;
	
	I2C_Delay(3);
	while(i--)
	{
		I2C_SCL_L;
		I2C_Delay(3);
		if(SendByte&0x80)
			I2C_SDA_H;  
		else 
			I2C_SDA_L;   
		SendByte<<=1;
		I2C_Delay(1);
		I2C_SCL_H;        //置时钟线为高，通知被控器开始接收数据位
		I2C_Delay(6);//保证时钟高电平周期大于4u
	}
	I2C_SCL_L;
}
//==================================================================================================
//| 函数名称 | I2C_ReceiveByte 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 接收1个字节数据
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 接收到的1个字节数据
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 数据从高位到低位
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
unsigned char I2C_ReceiveByte(void) 
{ 
	unsigned char i=8;
	unsigned char ReceiveByte=0;

	I2C_Delay(3);
	I2C_SDA_H;     //置数据线为输入方式
	while(i--)
	{
		I2C_Delay(3);
		ReceiveByte<<=1;      
		I2C_SCL_L;    //置时钟线为低，准备接收数据位
		I2C_Delay(6); //时钟低电平周期大于4.7u
		I2C_SCL_H;    //置时钟线为高使数据线上数据有效
		I2C_Delay(3); 
		if(I2C_SDA_READ())//读数据位
		{
			ReceiveByte|=0x01;
		}
	}
	I2C_SCL_L;
	return ReceiveByte;
}

//==================================================================================================
//| 函数名称 | I2C_WriteByte 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 写入1字节数据
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | SendByte      写入1字节数据
//|          | WriteAddress  待写入数据
//|          | WriteAddress  待写入地址
//|          | DeviceAddress 器件地址
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 0  失败
//|          | 1  成功
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
unsigned char I2C_WriteByte(unsigned char SendByte, unsigned int WriteAddress, unsigned char DeviceAddress)
{  
    if(!I2C_Start())
	{
		return 0;
	}
    I2C_SendByte( DeviceAddress & 0xFE);//写器件地址 
    if(!I2C_WaitAck())
	{
		I2C_Stop(); 
		return 0;
	}
//    I2C_SendByte((unsigned char)((WriteAddress>>8) & 0xFF));   //设置高起始地址      
//    I2C_WaitAck(); 
    I2C_SendByte((unsigned char)((WriteAddress) & 0xFF));   //设置低起始地址      
    if(!I2C_WaitAck())
	{
		I2C_Stop(); 
		return 0;
	}
    I2C_SendByte(SendByte);          //写数据
    if(!I2C_WaitAck())
	{
		I2C_Stop(); 
		return 0;
	}  
    I2C_Stop(); 
	
	//注意：因为这里要等待操作写完，可以采用查询或延时方式(10ms)
    I2C_Delay(10);
    return 1;
}

//==================================================================================================
//| 函数名称 | I2C_ReceiveByte 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 读出1字节数据
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | ReadAddress   待读出地址
//|          | DeviceAddress 器件地址
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 读取到的1个字节数据
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
unsigned char I2C_ReadByte(unsigned int ReadAddress,  unsigned char DeviceAddress, unsigned char* pDat)
{  
    unsigned char temp;
	
    if(!I2C_Start())
	{
		return 0;
	}

    I2C_SendByte((DeviceAddress & 0xFE));//写器件地址 
    if(!I2C_WaitAck())
	{
		I2C_Stop();
		return 0;
	}

    I2C_SendByte((unsigned char)((ReadAddress) & 0xFF));   //设置低起始地址      
    if(!I2C_WaitAck())
	{
		I2C_Stop();
		return 0;
	}
    if(!I2C_Start())
	{
		return 0;
	}
    I2C_SendByte((DeviceAddress & 0xFE)|0x01);    //读器件地址
    if(!I2C_WaitAck())
	{
		I2C_Stop();
		return 0;
	}
    temp = I2C_ReceiveByte();
    I2C_NoAck();    
    I2C_Stop();
	
	if(pDat != NULL)
	{
		*pDat = temp;
	}	
    return 1;
}


//==================================================================================================
//| 函数名称 | I2C_WriteData 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 通过I2C写入数据
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | WriteAddress  待写入的起始地址
//|          | DeviceAddress 器件地址
//|          | pDat  待写入的数据首地址
//|          | nLen  待写入的数据长度
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 0  失败
//|          | 1  成功
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
u8 I2C_WriteData(unsigned char DeviceAddress, unsigned int WriteAddress, unsigned char* pDat, unsigned int nLen)
{
	unsigned int i;
	
    if(!I2C_Start())
	{
		return 0;
	}
    I2C_SendByte( DeviceAddress & 0xFE);//写器件地址 
    if(!I2C_WaitAck())
	{
		I2C_Stop(); 
		return 0;
	}
//    I2C_SendByte((unsigned char)((WriteAddress>>8) & 0xFF));   //设置高起始地址      
//    I2C_WaitAck(); 
    I2C_SendByte((unsigned char)((WriteAddress) & 0xFF));   //设置低起始地址      
    if(!I2C_WaitAck())
	{
		I2C_Stop(); 
		return 0;
	}
	
	for(i=0;i<nLen;i++)
	{
		I2C_SendByte(*(pDat+i));          //写数据
		if(!I2C_WaitAck())
		{
			I2C_Stop(); 
			return 0;
		}	
	}
  
    I2C_Stop(); 

    return 1;
}

//==================================================================================================
//| 函数名称 | I2C_ReadData 
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 通过I2C读数据
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | WriteAddress  待读的起始地址
//|          | DeviceAddress 器件地址
//|          | pDat  待保存的数据首地址
//|          | nLen  待读入的数据长度
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 0  失败
//|          | 1  成功
//|----------|--------------------------------------------------------------------------------------       
//| 函数设计 | 编写人：ZH    时间：2014-03-01 
//|----------|-------------------------------------------------------------------------------------- 
//|   备注   | 
//|----------|-------------------------------------------------------------------------------------- 
//| 修改记录 | 修改人：          时间：         修改内容： 
//==================================================================================================
u8 I2C_ReadData(unsigned char DeviceAddress,  unsigned int ReadAddress, unsigned char* pDat, unsigned int nLen)
{
	unsigned int i;
	
	memset(pDat, 0, nLen);
	
    if(!I2C_Start())
	{
		return 0;
	}

    I2C_SendByte((DeviceAddress & 0xFE));//写器件地址 
    if(!I2C_WaitAck())
	{
		I2C_Stop();
		return 0;
	}

    I2C_SendByte((unsigned char)((ReadAddress) & 0xFF));   //设置低起始地址      
    if(!I2C_WaitAck())
	{
		I2C_Stop();
		return 0;
	}
    if(!I2C_Start())
	{
		return 0;
	}
    I2C_SendByte((DeviceAddress & 0xFE)|0x01);    //读器件地址
    if(!I2C_WaitAck())
	{
		I2C_Stop();
		return 0;
	}
	for(i=0; i<nLen; i++)
	{
		*(pDat+i) = I2C_ReceiveByte();
		I2C_Ack();		
//		if(!I2C_WaitAck())
//		{
//			I2C_Stop();
//			return 0;
//		}		
	}  
    I2C_NoAck();    
    I2C_Stop();
	
    return 1;
}

